<!DOCTYPE html>

<html>
    <head>
        <title>IPSec VPN Configuration</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700">
        <link rel="stylesheet" type="text/css" href="css/main.css">
        <!-- Font Awesome -->
        <script src="https://use.fontawesome.com/de3a0aea15.js"></script>
        <!-- jQuery -->
        <script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
        <script src="js/main.js"></script>
        <!-- animate.css -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">

    </head>

    <body>
        <header>
            <div class="header-title">
                <span class="section-title">IPSec VPN 架设教程</span></br>
                <span class="section-data">Last Modified: 2016.08.27</span>
            </div>
        </header>

        <ul class="content">
            <li><a href="#introduction">IPSec 简介<span>></span></a></li>
            <li><a href="#precondition">开始之前<span>></span></a></li>
            <li><a href="#installation" id="nav-ins">安装 Strongswan<span>+</span></a></li>
            <li><a href="#certification" id="nav-cer">生成证书<span>+</span></a></li>
            <li><a href="#config" id="nav-cfg">Strongswan 配置<span>+</span></a></li>
            <li><a href="#iptable"id="nav-ipt">配置防火墙<span>+</span></a></li>
            <li><a href="#ipsec-start">启用 IPSec<span>></span></a></li>
            <li><a>客户端设置<span>+</span></a></li>
            <li><a href="">返回顶端<span id="toTop">></span></a></li>
        </ul>

        <div id="container">
            <div id="summary">
                <p>
                    A Chinese guide for IPSec IKEv1/v2 VPN setup on CentOS/Ubuntu VPS
                    <br>
                    在CentOS/Ubuntu使用Strongswan架设IPSec Ikev1/v2 VPN 教程
                </p>
            </div>

            <div id="introduction">
                <h2>IPSec 简介</h2>
                <p>
                IPSec是虚拟私密网络(VPN)的一种协议，它通过认证和加密每一个IP数据包来确保IP通信的安全。它由两个阶段组成，第一阶段（Phrase 1, ph1），交换金钥建立连接，使用互联网金钥交换（ike）协议; 第二阶段（Phrase 2, ph2），连接建立后对数据进行加密传输，使用封装安全载荷（esp）协议。
                </br>
                参考：<a href="https://en.wikipedia.org/wiki/IPsec">维基百科 IPsec 词条(En)<i class="fa fa-external-link fa-fw"></i></a>
                </p>
            </div>

            <div id="precondition">
                <h2>开始之前</h2>
                <div class="info-bar">
                    <i class="fa fa-exclamation-circle fa-lg"></i>若已清楚VPS虚拟化类型及其 tun/tap 支持ppp, 请跳到<a href="#installation">#安装 Strongswan</a>
                </div>
                <div>

                <p>用ssh连接上你的VPS, 在命令行中输入下列命令:</p>
                <pre><code>
$ <span>cat</span> /dev/net/tun 
                </code></pre>
                <p>输出应该是:</p>
                <pre><code>
<span>cat</span>: /dev/net/tun: File descriptor in bad state
                </code></pre>
                <p>再输入以下命令:</p>
                <pre><code>
$ <span>cat</span> /dev/ppp 
                </code></pre>
                <p>输出应该是:</p>
                <pre><code>
<span>cat</span>: /dev/ppp: No such device or address
                </code></pre>
                <p>若没有以上输出则无法继续下一步, 请联系你VPS的客服</p>

                </div>
            </div>

            <div id="installation">
                <h2>安装 Strongswan</h2>
                <div class="info-bar">
                    <i class="fa fa-exclamation-circle fa-lg"></i>建议使用手动安装, 特别是OpenVZ的VPS
                </div>
                <h4><span class="step">1</span>安装必须的依赖</h4>
                <ul class="btn-group">
                    <li><a class="btn-release btn-press" id="installation-btn-l" href="javascript:void(0)">CentOS</a></li>
                    <li><a class="btn-release" id="installation-btn-r" href="javascript:void(0)">Ubuntu</a></li>
                </ul>
                <div id="installation-os-c">
                    <p><i class="fa fa-chevron-circle-right fa-fw"></i> CentOS:</p>
                    <pre><code>
# yum update
# yum install gmp-devel pam-devel openssl-devel libssl-dev make gcc
                    </code></pre>
                </div>
                <div id="installation-os-u">
                    <p><i class="fa fa-chevron-circle-right fa-fw"></i> Ubuntu:</p>
                    <pre><code>
# apt-get update
# apt-get install libgmp3-dev openssl libssl-dev make gcc
                    </code></pre>
                </div>
                <h4><span class="step">2</span>下载Strongswan</h4>
                <pre><code>
$ wget http://download.strongswan.org/strongswan.tar.bz2
$ tar xjvf strongswan.tar.bz2
$ cd strongswan-*
                </code></pre>
                <h4><span class="step">3</span>编译</h4>
                <ul class="btn-group">
                    <li><a class="btn-release" id="build-btn-l" href="javascript:void(0)">Xen、KVM</a></li>
                    <li><a class="btn-release btn-press" id="build-btn-r" href="javascript:void(0)">OpenVZ</a></li>
                </ul>
                <div id="build-kvm">
                    <p><i class="fa fa-chevron-circle-right fa-fw"></i> Xen、KVM类型</p>
                    <pre><code>
$ ./configure --prefix=/usr --sysconfdir=/etc \
    --enable-eap-mschapv2 --enable-xauth-eap --enable-eap-identity --enable-eap-tls \
    --enable-eap-ttls --enable-eap-md5 --enable-eap-tnc --enable-eap-dynamic \
    --enable-openssl --disable-gmp --enable-eap-aka --enable-nat-transport
                    </code></pre>
                </div>
                <div id="build-openvz">
                    <p><i class="fa fa-chevron-circle-right fa-fw"></i> OpenVZ类型 (需添加<b style="color:red">enable-kernel-libipsec</b>)</p>
                    <pre><code>
$ ./configure --prefix=/usr --sysconfdir=/etc \
    --enable-eap-mschapv2 --enable-xauth-eap --enable-eap-identity --enable-eap-tls \
    --enable-eap-ttls --enable-eap-md5 --enable-eap-tnc --enable-eap-dynamic \
    --enable-openssl --disable-gmp --enable-eap-aka --enable-nat-transport \
    --enable-kernel-libipsec 
                    </code></pre>
                </div>
                <h4><span class="step">4</span>安装</h4>
                <div class="warn-bar">
                    <i class="fa fa-exclamation-triangle fa-lg"></i>不要make && make install, 请确保make的时候没有错误提示
                </div>
                <pre><code>
# make
# make install
                </code></pre>
            </div>

            <div id="certification">
                <h2>生成证书</h2>
                <h4><span class="step">1</span>生成自签名的根证书 (root CA)</h4>
                <pre><code>
$ cd /etc/ipsec.d/
$ ipsec pki --gen --type rsa --size 2048 \
            --outform pem \
            > private/ca.key.pem
$ chmod 600 private/ca.key.pem
$ ipsec pki --self --ca --lifetime 730 \
            --in private/ca.key.pem --type rsa \
            --dn "C=CN, O=strongSwan, CN=strongSwan Root CA" \
            --outform pem \
            > cacerts/ca.cert.pem
                </code></pre>
                <p>
                    size 2048: 2048 bit 的 RSA 密钥
                    <br>
                    lifetime 730: 730天 (2年)
                    <br>
                    dn: C 代表国家, O 代表组织, CN(common name) 代表名称
                </p>
                <h4><span class="step">2</span>生成服务器证书 (host CA)</h4>
                <pre><code>
$ cd /etc/ipsec.d/
$ ipsec pki --gen --type rsa --size 2048 \
            --outform pem \
            > private/host.key.pem
$ chmod 600 private/host.key.pem
$ ipsec pki --pub --in private/host.key.pem --type rsa | \
            ipsec pki --issue --lifetime 730 \
            --cacert cacerts/ca.cert.pem \
            --cakey private/ca.key.pem \
            --dn "C=CN, O=strongSwan, CN=vpn.example.com" \
            --san "1.2.3.4" \
            --flag serverAuth --flag ikeIntermediate \
            --outform pem > certs/host.cert.pem
                </code></pre>
                <p>
                    CN: 填的是你服务器的 URL 或 IP
                    <br>
                    san: 填的是服务器IP
                </p>
                <h4><span class="step">3</span>生成客户端证书 (client CA)</h4>
                <pre><code>
$ cd /etc/ipsec.d/
$ ipsec pki --gen --type rsa --size 2048 \
            --outform pem \
            > private/client.key.pem
$ chmod 600 private/client.key.pem
$ ipsec pki --pub --in private/client.key.pem --type rsa | \
            ipsec pki --issue --lifetime 730 \
            --cacert cacerts/ca.cert.pem \
            --cakey private/ca.key.pem \
            --dn "C=CN, O=strongSwan, CN=myself@example.com" \
            --san myself@example.com \
            --outform pem > certs/client.cert.pem
                </code></pre>
                <h4><span class="step">4</span>生成pkcs12证书</h4>
                <div class="info-bar">
                    <i class="fa fa-exclamation-circle fa-lg"></i>使用IKEv2一定要生成该证书
                </div>
                <pre><code>
$ openssl pkcs12 -export -inkey private/client.key.pem \
        -in certs/client.cert.pem -name "My own VPN client certificate" \
        -certfile cacerts/ca.cert.pem \
        -caname "strongSwan Root CA" \
        -out client.p12
                </code></pre>
                <div class="danger-bar">
                    <i class="fa fa-ban fa-lg"></i>caname 一定要与<a href="#certification">第一步</a>的 CN(common name) 一致
                </div>
                <p>
                    生成该证书时要输入密码，在客户端安装该证书时会用到这个密码。
                    <br>
                    为在IOS设备上安装密码最好为4位数字，密码也可以为空
                    <br>
                    然后将该证书发生到客户端安装 (IOS设备要发送ca.cert.pem和client.p12)
                    <br>
                    更详细参考Strongswan Wiki: <a href="https://wiki.strongswan.org/projects/strongswan/wiki/AppleClients">IKEv2 on iOS 9 & OS X 10.11<i class="fa fa-external-link fa-fw"></i></a> / <a href="https://wiki.strongswan.org/projects/strongswan/wiki/Win7Certs">IKEv2 on Win7+<i class="fa fa-external-link fa-fw"></i></a>
                </p>
                <div class="warn-bar">
                    <i class="fa fa-exclamation-triangle fa-lg"></i>生成证书后请把根证书私钥(ca.key.pem)移动到无法联网的设备上储存
                </div>
            </div>

            <div id="config">
                <h2>Strongswan 配置</h2>
                <div class="info-bar">
                    <i class="fa fa-check-circle fa-lg"></i>配置文件可以从我 <a href="https://github.com/caasiu/ipsec-config">Github</a> 下载
                </div>
                <h4><span class="step">1</span>编辑 ipsec.conf</h4>
                <pre><code>
# /etc/ipsec.conf
# ipsec.conf - strongSwan IPsec configuration file

# basic configuration

config setup
    # strictcrlpolicy=yes
    uniqueids = never


conn %default
    keyexchange = ike
    
    dpdaction = clear
    dpddelay = 35s
    dpdtimeout = 300s


# for IOS 6+ and Android 4+ without install CA
conn IPSec-IKEv1-PSK
    keyexchange = ikev1
    fragmentation = yes
    
    #left -- local(server) side
    left = %any
    leftauth = psk
    leftsubnet = 0.0.0.0/0

    #right -- remote(client) side
    right = %any
    rightauth = psk
    rightauth2 = xauth
    rightsourceip = 10.36.1.0/24

    auto = add


# for IOS 8+ Android 4.4+ Win 7+
conn IPSec-IKEv2
    keyexchange = ikev2
    ike = aes256-sha1-modp1024,aes128-sha1-modp1024,3des-sha1-modp1024!
    esp = aes256-sha256,aes256-sha1,3des-sha1!
    eap_identity = %any
    fragmentation = yes
    rekey = no
    
    #left -- local(server) side
    left = %any
    leftauth = pubkey
    leftcert = host.cert.pem
    leftsubnet = 0.0.0.0/0
    leftsendcert = always

    #right -- remote(client) side
    right = %any
    rightauth = eap-mschapv2
    rightcert = client.cert.pem
    rightsourceip = 10.36.2.0/24
    rightsendcert = never

    auto = add
                </code></pre>
                <h4><span class="step">2</span>编辑 ipsec.secrets</h4>
                <pre><code>
# /etc/ipsec.secrets
# ipsec.secrets

: RSA host.key.pem
: PSK "your_psk"

# use XAUTH
user1 : XAUTH "password"
user2 : XAUTH "password"

# use EAP
user3 : EAP "password"
user4 : EAP "password"
                </code></pre>
                <h4><span class="step">3</span>编辑 strongswan.conf</h4>
                <pre><code>
# /etc/strongswan.conf - strongSwan configuration file

charon {
    load_modular = yes
    duplicheck.enable = no #是为了你能同时连接多个设备，所以要把冗余检查关闭
    compress = yes
    plugins {
        include strongswan.d/charon/*.conf
                            
    }

    dns1 = 8.8.4.4
    dns2 = 8.8.8.8

    # for Windows WINS Server
    nbns1 = 8.8.4.4
    nbns2 = 8.8.8.8
}

include strongswan.d/*.conf
                </code></pre>
            </div>

            <div id="iptable">
                <h2>配置防火墙</h2>
                <h4><span class="step">1</span>编辑 sysctl.conf</h4>
                <p>在 /etc/sysctl.conf 中增加如下行或去掉下列行的"#", 保存后执行 sysctl -p</p>
                <div class="warn-bar">
                    <i class="fa fa-exclamation-triangle fa-lg"></i>若执行后报错, 重新编辑 sysctl.conf 将报错的部分#注释掉保存, <span style="color:red">直到执行sysctl -p不再报错为止</span>
                </div>
                <pre><code>
net.ipv4.ip_forward = 1
net.ipv4.conf.all.accept_redirects = 0 
net.ipv4.conf.all.send_redirects = 0
net.ipv6.conf.all.forwarding = 1

net.ipv4.tcp_syncookies = 1
                </pre></code>
                <h4><span class="step">2</span>设置 iptables 转发</h4>
                <div class="info-bar">
                    <i class="fa fa-exclamation-circle fa-lg"></i>venet0 / eth0 以系统网卡名称为准
                </div>
                <ul class="btn-group">
                    <li><a id="transfer-btn-l" class="btn-release" href="javascript:void(0)">Xen、KVM</a></li>
                    <li><a id="transfer-btn-r" class="btn-release btn-press" href="javascript:void(0)">OpenVZ</a></li>
                </ul>
                <div id="transfer-openvz">
                <p><i class="fa fa-chevron-circle-right fa-fw"></i> OpenVZ类型, 执行:</p>
                <pre><code>
# iptables -A INPUT -i venet0 -p esp -j ACCEPT
# iptables -A INPUT -i venet0 -p udp --dport 500 -j ACCEPT
# iptables -A INPUT -i venet0 -p udp --dport 4500 -j ACCEPT
# iptables -t nat -A POSTROUTING -s 10.36.1.0/24 -o venet0 -j MASQUERADE
# iptables -t nat -A POSTROUTING -s 10.36.2.0/24 -o venet0 -j MASQUERADE
# iptables -A FORWARD -s 10.36.1.0/24  -j ACCEPT
# iptables -A FORWARD -s 10.36.2.0/24  -j ACCEPT
                </code></pre>
                </div>
                <div id="transfer-kvm">
                <p><i class="fa fa-chevron-circle-right fa-fw"></i> Xen、KVM类型, 执行:</p>
                <pre><code>
# iptables -A INPUT -i eth0 -p esp -j ACCEPT
# iptables -A INPUT -i eth0 -p udp --dport 500 -j ACCEPT
# iptables -A INPUT -i eth0 -p udp --dport 4500 -j ACCEPT
# iptables -t nat -A POSTROUTING -s 10.36.1.0/24 -o eth0 -j MASQUERADE
# iptables -t nat -A POSTROUTING -s 10.36.2.0/24 -o eth0 -j MASQUERADE
# iptables -A FORWARD -s 10.36.1.0/24  -j ACCEPT
# iptables -A FORWARD -s 10.36.2.0/24  -j ACCEPT
                </code></pre>
                </div>
                <h4><span class="step">3</span>开机自动载入 iptables 设定</h4>
                <ul class="btn-group">
                    <li><a id="startup-btn-l" class="btn-release btn-press" href="javascript:void(0)">CentOS</a></li>
                    <li><a id="startup-btn-r" class="btn-release" href="javascript:void(0)">Ubuntu</a></li>
                </ul>
                <div id="startup-os-c">
                <p><i class="fa fa-chevron-circle-right fa-fw"></i> CentOS, 执行:</p>
                <pre><code>
# /sbin/service iptables save
                </code></pre>
                </div>
                <div id="startup-os-u">
                <p><i class="fa fa-chevron-circle-right fa-fw"></i> Ubuntu:</p>
                <p>先将防火墙规则保存到/etc/iptables.up.rules文件中</p>
                <pre><code>
# iptables-save > /etc/iptables.up.rules
                </code></pre>
                <p>然后修改/etc/network/interfaces，在网卡eth0手动添加最后一行:</p>
                <pre><code>
auto eth0
iface eth0 inet dhcp
pre-up iptables-restore < /etc/iptables.up.rules
                </code></pre>
                <p>详细参考：<a href="https://help.ubuntu.com/community/IptablesHowTo">Ubuntu IptablesHowTo<i class="fa fa-external-link fa-fw"></i></a></p>
                </div>
            </div>

            <div id="ipsec-start">
                <h2>启用 IPSec</h2>
                <pre><code>
# ipsec start
                </code></pre>
                <p><i class="fa fa-chevron-circle-right fa-fw"></i> CentOS 7 / Ubuntu 开机自启动:</p>
                <pre><code>
# systemctl enable strongswan
                </code></pre>
                <div class="info-bar">
                    <i class="fa fa-check-circle fa-lg"></i>至此，IPSec VPN 搭建完毕
                </div>
            </div>

        </div>

        <footer>
            <div>
                <div class="footer-left">
                    <p>&copy; 2016 Caasiu Roger</p>
                </div>
                <div class="footer-right">
                    <ul>
                        <li>
                            <a href="mailto:caasiu@outlook.com">
                                <i class="fa fa-envelope fa-fw"></i> Email
                            </a>
                        </li>
                        <li>
                            <a href="https://github.com/caasiu/ipsec-config">
                                <i class="fa fa-github-square fa-fw"></i> Github
                            </a>
                        </li>
                        <li>
                            <a href="">
                                <i class="fa fa-bars fa-fw"></i> About
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </footer>

    </body>

</html>
